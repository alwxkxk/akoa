# 账号体系的设计
## 功能需求分析
此应用的账号体系所需要的功能包括（按重要性排序）：
- 注册、删除账号、登陆、注销
- token、修改密码、用户组体系
- 修改昵称、检测账号重名
- excel批量上传账号

## token
token是账号凭证。登陆成功后生成token并保存至redis（两条缓存，name:token,token:账号信息），response body中包含token并set-cookie，后面相关操作的请求都会检查cookie或header里的token有无效，通过token从redis找到用户名name再继续操作。
![token 生成与使用](http://on-img.com/chart_image/5a1eae54e4b0b3ee0575b5f6.png)
### token组成
为了能够通过name找到token,通过token找到name，所以每次登陆成功后都会在redis里生成两条缓存。每次登陆都会刷新token并且使旧的token失效，每个token的生存时间被设置为1小时（可在配置文件里修改）。token里包含该用户的用户组信息，用于API请求时检验是否有权限。
```
name:'token'

token:{ //redis中的hash结构
 name:'name',
 create_time:'YY-MM-DD HH:mm:ss',
 group_id:1
}
```


## 权限组 与 权限验证
### 权限组id（group_id）
不同的权限组拥有不同的权限，每次操作都会由后台判断是否拥有权限进行该操作，前端可自行配置以对应不同的渲染。
0. 普通用户：正常使用功能
1. 管理员：拥有管理权限
备注：当出现需要区分不同的用户时，在数据库添加一个字段区分即可。
### 权限验证
权限验证暂时还不需要太细，所以只需要考虑某个操作需要属于哪些权限组即可，在配置文件里配置(config/authentication.js)。大部分操作都必须有token才许操作，而且普通用户的token不能做管理员的事。

## 日志
所有请求最原始的数据都由nginx保存下来，系统本身日志文件保存到/log，每个用户的动作的日志文件保存到/log/user/{name}.log。

## 安全
###  登陆
不使用验证码，采用记录IP地址，每个IP地址每分钟不超过20次登陆，每天不超过50个。（待做）后期可用安全检测模块如snyk,nsp等检测一下。
### 敏感操作
所有敏感操作都需要先申请生成sensitiveToken(通过弹窗重输密码，发送验证邮箱等获得)，再将这个sensitiveToken放到header里发出敏感操作的API请求，有效时间30分钟。敏感操作会从这个sensitiveToken得到用户名name,以及从cookie或header里从用户凭证token里得到用户名name,两者相同才会进行敏感操作。
- sensitiveToken的组成：sensitiveToken:name。
- 敏感操作：修改密码、修改验证邮箱、


